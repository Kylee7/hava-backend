<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - Perfect Cfw</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a0b2e 0%, #2d1b4e 100%);
            min-height: 100vh;
            color: white;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(167, 139, 250, 0.2);
        }

        .header h1 {
            color: #a78bfa;
            font-size: 28px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn-logout {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #fca5a5;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: #ef4444;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(167, 139, 250, 0.2);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
        }

        .stat-card i {
            font-size: 48px;
            color: #a78bfa;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #cbd5e1;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .btn-add {
            background: linear-gradient(135deg, #7c3aed, #9333ea);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.4);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-filter {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(167, 139, 250, 0.3);
            color: #cbd5e1;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-filter.active {
            background: linear-gradient(135deg, #7c3aed, #9333ea);
            border-color: #7c3aed;
            color: white;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(167, 139, 250, 0.2);
            border-radius: 20px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: #a78bfa;
        }

        .product-image {
            text-align: center;
            padding: 20px;
            margin-bottom: 15px;
        }

        .product-image img {
            max-width: 100%;
            max-height: 120px;
            object-fit: contain;
            border-radius: 10px;
        }

        .product-image i {
            font-size: 60px;
            color: #a78bfa;
        }

        .product-info h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #a78bfa;
        }

        .product-info p {
            color: #cbd5e1;
            margin-bottom: 5px;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-edit, .btn-delete {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            color: #86efac;
        }

        .btn-edit:hover {
            background: #22c55e;
            color: white;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #fca5a5;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a0b2e;
            border: 2px solid #a78bfa;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            color: #a78bfa;
        }

        .btn-close {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #cbd5e1;
            font-weight: 600;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(167, 139, 250, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #a78bfa;
        }

        .btn-save {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #7c3aed, #9333ea);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Cairo', sans-family;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading i {
            font-size: 48px;
            color: #a78bfa;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fcd34d;
        }
    </style>
    <script src="js/modal-system.js"></script>
    <link rel="stylesheet" href="css/modal-system.css">
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-shield-halved"></i> لوحة التحكم - Perfect Cfw</h1>
        <div class="user-info">
            <a href="rules-manager.html" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; margin-left: 15px; font-weight: 600;">
                <i class="fas fa-book"></i> القوانين
            </a>
            <a href="questions-manager.html" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; margin-left: 15px; font-weight: 600;">
                <i class="fas fa-question-circle"></i> الأسئلة
            </a>
            <a href="applications-manager.html" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; margin-left: 15px; font-weight: 600;">
                <i class="fas fa-clipboard-list"></i> التقديمات
            </a>
            <a href="discount-codes.html" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; margin-left: 15px; font-weight: 600;">
                <i class="fas fa-tag"></i> أكواد الخصم
            </a>
            <a href="activity-logs.html" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; margin-left: 15px; font-weight: 600;">
                <i class="fas fa-history"></i> السجلات
            </a>
            <a href="admins.html" id="adminsLink" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 10px 20px; border-radius: 10px; text-decoration: none; margin-left: 15px; font-weight: 600; display: none;">
                <i class="fas fa-users-cog"></i> المسؤولين
            </a>
            <span id="username">مرحباً، Admin</span>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-box"></i>
                <h3 id="totalProducts">0</h3>
                <p>إجمالي المنتجات</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-car"></i>
                <h3 id="vehiclesCount">0</h3>
                <p>المركبات</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-crown"></i>
                <h3 id="vipCount">0</h3>
                <p>VIP</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <h3 id="activeProducts">0</h3>
                <p>المنتجات النشطة</p>
            </div>
        </div>

        <div class="controls">
            <button class="btn-add" onclick="openAddModal()">
                <i class="fas fa-plus"></i> إضافة منتج جديد
            </button>
            
            <div class="filter-buttons">
                <button class="btn-filter active" onclick="filterProducts('all')">الكل</button>
                <button class="btn-filter" onclick="filterProducts('vehicles')">المركبات</button>
                <button class="btn-filter" onclick="filterProducts('vip')">VIP</button>
                <button class="btn-filter" onclick="filterProducts('money')">رصيد</button>
                <button class="btn-filter" onclick="filterProducts('properties')">عقارات</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-circle-notch"></i>
            <p>جاري تحميل المنتجات...</p>
        </div>

        <div id="productsGrid" class="products-grid"></div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">إضافة منتج جديد</h2>
                <button class="btn-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label>اسم المنتج</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-group">
                    <label>السعر (USD)</label>
                    <input type="number" id="productPrice" min="0" required>
                </div>

                <div class="form-group">
                    <label>الفئة</label>
                    <select id="productCategory" required>
                        <option value="vehicles">المركبات</option>
                        <option value="money">رصيد موقع</option>
                        <option value="planes">الطائرات</option>
                        <option value="properties">العقارات</option>
                        <option value="xp">ضعف الخبرة</option>
                        <option value="vip">VIP</option>
                        <option value="premium">الحصريات</option>
                        <option value="other">أخرى</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>الكمية المتاحة</label>
                    <input type="number" id="productStock" min="0" required>
                </div>

                <div class="form-group">
                    <label>نص الكمية</label>
                    <input type="text" id="productStockText" placeholder="مثال: يوجد 10 من المنتجات">
                </div>

                <div class="form-group">
                    <label>رابط الصورة</label>
                    <input type="text" id="productImage" placeholder="images/product.png">
                </div>

                <div class="form-group">
                    <label>أيقونة Font Awesome</label>
                    <input type="text" id="productIcon" placeholder="fas fa-car">
                </div>

                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>

                <button type="submit" class="btn-save">
                    <i class="fas fa-save"></i> حفظ المنتج
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://perfect-backend-production.up.railway.app/api';
        let products = [];
        let currentFilter = 'all';
        let editingProductId = null;

        // Check authentication
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = 'admin-login.html';
        }

        // Check if superadmin and show admins link
        async function checkSuperAdmin() {
            try {
                const response = await fetch(`${API_URL}/admins/check-superadmin`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                if (data.success && data.isSuperAdmin) {
                    document.getElementById('adminsLink').style.display = 'inline-block';
                }
            } catch (error) {
                // Ignore error, link stays hidden
            }
        }

        // Load products on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            checkSuperAdmin();
        });

        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}/products`);
                const data = await response.json();
                
                if (data.success) {
                    products = data.data;
                    displayProducts();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading products:', error);
                modalSystem.showAlert('خطأ', 'خطأ في تحميل المنتجات', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayProducts() {
            const grid = document.getElementById('productsGrid');
            const filtered = currentFilter === 'all' 
                ? products 
                : products.filter(p => p.category === currentFilter);
            
            if (filtered.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #cbd5e1;">لا توجد منتجات</p>';
                return;
            }

            grid.innerHTML = filtered.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.image 
                            ? `<img src="${product.image}" alt="${product.name}">`
                            : `<i class="${product.icon || 'fas fa-box'}"></i>`
                        }
                    </div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <p><strong>السعر:</strong> $${product.price}</p>
                        <p><strong>الكمية:</strong> ${product.stockText || product.stock}</p>
                        <p><strong>الفئة:</strong> ${getCategoryName(product.category)}</p>
                        ${product.active 
                            ? '<span class="badge badge-success">نشط</span>'
                            : '<span class="badge badge-warning">غير نشط</span>'
                        }
                    </div>
                    <div class="product-actions">
                        <button class="btn-edit" onclick="editProduct('${product._id}')">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn-delete" onclick="deleteProduct('${product._id}')">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('vehiclesCount').textContent = 
                products.filter(p => p.category === 'vehicles').length;
            document.getElementById('vipCount').textContent = 
                products.filter(p => p.category === 'vip').length;
            document.getElementById('activeProducts').textContent = 
                products.filter(p => p.active).length;
        }

        function filterProducts(category) {
            currentFilter = category;
            
            // Update button styles
            document.querySelectorAll('.btn-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            displayProducts();
        }

        function getCategoryName(category) {
            const names = {
                vehicles: 'المركبات',
                money: 'رصيد موقع',
                planes: 'الطائرات',
                properties: 'العقارات',
                xp: 'ضعف الخبرة',
                vip: 'VIP',
                premium: 'الحصريات',
                other: 'أخرى'
            };
            return names[category] || category;
        }

        function openAddModal() {
            editingProductId = null;
            document.getElementById('modalTitle').textContent = 'إضافة منتج جديد';
            document.getElementById('productForm').reset();
            document.getElementById('productModal').classList.add('active');
        }

        function editProduct(id) {
            editingProductId = id;
            const product = products.find(p => p._id === id);
            
            if (!product) return;
            
            document.getElementById('modalTitle').textContent = 'تعديل المنتج';
            document.getElementById('productId').value = product._id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productStockText').value = product.stockText || '';
            document.getElementById('productImage').value = product.image || '';
            document.getElementById('productIcon').value = product.icon || '';
            document.getElementById('productDescription').value = product.description || '';
            
            document.getElementById('productModal').classList.add('active');
        }

        async function deleteProduct(id) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
            
            try {
                const response = await fetch(`${API_URL}/products/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    modalSystem.showAlert('نجح!', 'تم حذف المنتج بنجاح', 'success');
                    loadProducts();
                } else {
                    modalSystem.showAlert('خطأ', data.message || 'فشل حذف المنتج', 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                modalSystem.showAlert('خطأ', 'خطأ في حذف المنتج', 'error');
            }
        }

        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value),
                stockText: document.getElementById('productStockText').value,
                image: document.getElementById('productImage').value,
                icon: document.getElementById('productIcon').value,
                description: document.getElementById('productDescription').value,
                active: true
            };
            
            try {
                const url = editingProductId 
                    ? `${API_URL}/products/${editingProductId}`
                    : `${API_URL}/products`;
                
                const method = editingProductId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    modalSystem.showAlert('نجح!', editingProductId ? 'تم تعديل المنتج بنجاح' : 'تم إضافة المنتج بنجاح', 'success');
                    closeModal();
                    loadProducts();
                } else {
                    modalSystem.showAlert('خطأ', data.message || 'فشلت العملية', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                modalSystem.showAlert('خطأ', 'خطأ في حفظ المنتج', 'error');
            }
        });

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            window.location.href = 'admin-login.html';
        }
    </script>
</body>
</html>
